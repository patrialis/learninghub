<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cours - LearningHub</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --brown: #8B6F47; --dark-brown: #6B5A3B; --beige: #E8DCC4; --light-gray: #F5F5F0; --green: #6B9F7F; --dark-green: #5A8A6E; }
        html, body { height: 100%; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Top bar - minimal */
        .top-bar { height: 50px; background: var(--brown); color: white; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        .top-bar h1 { font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        .top-bar h1 span { color: var(--green); }
        .top-bar-actions { display: flex; gap: 10px; align-items: center; }
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 0.85rem; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; }
        .btn-light { background: rgba(255,255,255,0.2); color: white; }
        .btn-light:hover { background: rgba(255,255,255,0.3); }
        .btn-green { background: var(--green); color: white; }
        .btn-green:hover { background: var(--dark-green); }
        
        /* Course content - FULLSCREEN */
        .course-frame { width: 100%; height: calc(100vh - 50px); border: none; background: white; }
        
        /* Side panel (hidden by default) */
        .side-panel { position: fixed; right: -350px; top: 50px; width: 350px; height: calc(100vh - 50px); background: white; box-shadow: -5px 0 20px rgba(0,0,0,0.1); transition: right 0.3s; z-index: 100; overflow-y: auto; }
        .side-panel.open { right: 0; }
        .panel-header { padding: 20px; background: var(--light-gray); display: flex; justify-content: space-between; align-items: center; }
        .panel-header h3 { color: var(--dark-brown); }
        .close-panel { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #888; }
        .panel-content { padding: 20px; }
        
        /* Progress */
        .progress-section { margin-bottom: 25px; }
        .progress-bar { height: 10px; background: var(--beige); border-radius: 5px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: var(--green); }
        .progress-text { font-size: 0.9rem; color: var(--dark-brown); font-weight: 600; }
        
        /* Modules */
        .module-item { padding: 12px 15px; background: var(--light-gray); border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .module-item:hover { background: var(--beige); }
        .module-item.completed { border-left: 3px solid var(--green); }
        .module-check { width: 22px; height: 22px; border: 2px solid var(--beige); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; background: white; }
        .module-item.completed .module-check { background: var(--green); color: white; border: none; }
        .module-title { flex: 1; font-size: 0.85rem; }
        
        /* Complete button */
        .complete-btn { width: 100%; padding: 15px; margin-top: 20px; }
        
        /* Description */
        .description-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--beige); }
        .description-section h4 { color: var(--dark-brown); margin-bottom: 10px; }
        .description-section p { color: #666; font-size: 0.9rem; line-height: 1.6; }
        
        /* Loading */
        .loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .spinner { width: 50px; height: 50px; border: 4px solid var(--beige); border-top: 4px solid var(--green); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Overlay */
        .overlay { position: fixed; top: 50px; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); display: none; z-index: 50; }
        .overlay.open { display: block; }
    </style>
</head>
<body>
    <!-- Loading -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Chargement du cours...</p>
    </div>

    <!-- Top Bar -->
    <div class="top-bar" id="top-bar" style="display: none;">
        <h1>üéì <span id="course-title">Cours</span></h1>
        <div class="top-bar-actions">
            <button class="btn btn-green" onclick="togglePanel()">üìä Progression</button>
            <a href="instructor-dashboard.html" class="btn btn-light">‚Üê Retour</a>
            <button class="btn btn-light" onclick="handleLogout()">D√©connexion</button>
        </div>
    </div>

    <!-- Course Content - FULL SCREEN -->
    <iframe id="course-frame" class="course-frame" style="display: none;"></iframe>

    <!-- Overlay -->
    <div class="overlay" id="overlay" onclick="togglePanel()"></div>

    <!-- Side Panel -->
    <div class="side-panel" id="side-panel">
        <div class="panel-header">
            <h3>üìä Progression</h3>
            <button class="close-panel" onclick="togglePanel()">√ó</button>
        </div>
        <div class="panel-content">
            <div class="progress-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <div class="progress-text"><span id="progress-percent">0</span>% compl√©t√©</div>
            </div>
            
            <h4 style="color: var(--dark-brown); margin-bottom: 15px;">üìñ Modules</h4>
            <div id="modules-list"></div>
            
            <button class="btn btn-green complete-btn" onclick="markAsComplete()">‚úÖ Marquer comme termin√©</button>
            
            <div class="description-section">
                <h4>üìù Description</h4>
                <p id="course-description">Chargement...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAVO1P9v-IBsyxF_80vQvZDlR5tIqh878U",
            authDomain: "learncentric.firebaseapp.com",
            projectId: "learncentric",
            storageBucket: "learncentric.firebasestorage.app",
            messagingSenderId: "1083770541694",
            appId: "1:1083770541694:web:b8dbcd7852ca7d9c8fea2f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.signOut = signOut;
        window.doc = doc;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                const urlParams = new URLSearchParams(window.location.search);
                const courseId = urlParams.get('id');
                if (courseId) {
                    await loadCourse(courseId);
                } else {
                    window.location.href = 'instructor-dashboard.html';
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadCourse(courseId) {
            try {
                const courseDoc = await getDoc(doc(db, "courses", courseId));
                if (courseDoc.exists()) {
                    const course = courseDoc.data();
                    window.currentCourse = { id: courseId, ...course };
                    
                    document.getElementById('course-title').textContent = course.title || 'Cours';
                    document.getElementById('course-description').textContent = course.description || 'Aucune description.';
                    
                    window.courseCode = { html: course.codeHtml || '', css: course.codeCss || '', js: course.codeJs || '' };
                    
                    // Render course content in fullscreen iframe
                    renderCourseContent();
                    
                    displayModules(course.modules || []);
                    await loadUserProgress(courseId);
                    
                    // Show content
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('top-bar').style.display = 'flex';
                    document.getElementById('course-frame').style.display = 'block';
                }
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        async function loadUserProgress(courseId) {
            try {
                const userDoc = await getDoc(doc(db, "users", window.currentUser.uid));
                if (userDoc.exists()) {
                    const progress = userDoc.data().progress || {};
                    window.completedModules = progress[courseId]?.completedModules || [];
                    updateProgressDisplay();
                    updateModulesDisplay();
                }
            } catch (e) { window.completedModules = []; }
        }

        window.loadCourse = loadCourse;
    </script>

    <script>
        window.currentModuleIndex = 0;
        window.completedModules = [];

        function renderCourseContent() {
            const iframe = document.getElementById('course-frame');
            const html = window.courseCode?.html || '';
            const css = window.courseCode?.css || '';
            const js = window.courseCode?.js || '';
            
            if (!html && !css && !js) {
                iframe.contentDocument.open();
                iframe.contentDocument.write('<html><body style="display:flex;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;color:#888;"><p>Aucun contenu disponible pour ce cours.</p></body></html>');
                iframe.contentDocument.close();
                return;
            }
            
            const content = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 40px; 
            min-height: 100vh;
            background: #fff;
        }
        ${css}
    </style>
</head>
<body>
    ${html}
    <script>${js}<\/script>
</body>
</html>`;
            
            iframe.contentDocument.open();
            iframe.contentDocument.write(content);
            iframe.contentDocument.close();
        }

        function togglePanel() {
            document.getElementById('side-panel').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('open');
        }

        function displayModules(modules) {
            const list = document.getElementById('modules-list');
            if (!modules?.length) { 
                list.innerHTML = '<p style="color:#888;font-size:0.85rem;">Aucun module d√©fini</p>'; 
                return; 
            }
            list.innerHTML = modules.map((m, i) => `
                <div class="module-item" onclick="selectModule(${i})" id="module-${i}">
                    <div class="module-check" id="check-${i}">${i+1}</div>
                    <div class="module-title">${m.title}</div>
                </div>
            `).join('');
        }

        function updateModulesDisplay() {
            window.completedModules.forEach(i => {
                const el = document.getElementById(`module-${i}`);
                const ch = document.getElementById(`check-${i}`);
                if (el) el.classList.add('completed');
                if (ch) ch.textContent = '‚úì';
            });
        }

        function selectModule(i) {
            window.currentModuleIndex = i;
        }

        async function markAsComplete() {
            const i = window.currentModuleIndex;
            if (!window.completedModules.includes(i)) window.completedModules.push(i);
            const ch = document.getElementById(`check-${i}`);
            if (ch) ch.textContent = '‚úì';
            document.getElementById(`module-${i}`)?.classList.add('completed');
            updateProgressDisplay();
            
            try {
                const ref = window.doc(window.firebaseDb, "users", window.currentUser.uid);
                const snap = await window.getDoc(ref);
                if (snap.exists()) {
                    const progress = snap.data().progress || {};
                    const mods = window.currentCourse?.modules || [];
                    progress[window.currentCourse.id] = { 
                        completedModules: window.completedModules, 
                        percent: Math.round((window.completedModules.length / Math.max(mods.length, 1)) * 100) 
                    };
                    await window.updateDoc(ref, { progress });
                }
            } catch (e) { console.error(e); }
            
            alert('‚úÖ Module termin√© !');
        }

        function updateProgressDisplay() {
            const mods = window.currentCourse?.modules || [];
            const pct = Math.round((window.completedModules.length / Math.max(mods.length, 1)) * 100);
            document.getElementById('progress-fill').style.width = pct + '%';
            document.getElementById('progress-percent').textContent = pct;
        }

        async function handleLogout() { 
            await window.signOut(window.firebaseAuth); 
            window.location.href = 'index.html'; 
        }
    </script>
</body>
</html>
