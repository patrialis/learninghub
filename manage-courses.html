<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cours - LearningHub</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --brown: #8B6F47; --dark-brown: #6B5A3B; --beige: #E8DCC4; --light-gray: #F5F5F0; --green: #6B9F7F; --dark-green: #5A8A6E; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--light-gray); min-height: 100vh; padding: 20px; }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { color: var(--dark-brown); display: flex; align-items: center; gap: 10px; }
        .back-btn { background: var(--beige); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; color: var(--dark-brown); font-weight: 500; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
        .back-btn:hover { background: #d9cab3; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; }
        .tab { padding: 12px 25px; background: white; border: 2px solid var(--beige); border-radius: 10px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
        .tab.active { background: var(--green); color: white; border-color: var(--green); }
        .tab:hover:not(.active) { background: var(--beige); }
        
        .section { display: none; }
        .section.active { display: block; }
        
        .message { padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; display: none; }
        .message.success { background: #d4edda; color: #155724; display: block; }
        .message.error { background: #f8d7da; color: #721c24; display: block; }
        
        /* Courses Grid */
        .courses-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        
        .course-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: all 0.3s; }
        .course-card:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .course-header { background: linear-gradient(135deg, var(--green), var(--dark-green)); color: white; padding: 25px; position: relative; }
        .course-header h3 { font-size: 1.2rem; margin-bottom: 8px; padding-right: 80px; }
        .course-header p { opacity: 0.9; font-size: 0.9rem; }
        .course-status { position: absolute; top: 15px; right: 15px; padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; }
        .status-published { background: rgba(255,255,255,0.2); color: white; }
        .status-draft { background: #fff3cd; color: #856404; }
        
        .course-body { padding: 20px; }
        .course-stats { display: flex; gap: 20px; margin-bottom: 15px; }
        .course-stat { text-align: center; }
        .course-stat .number { font-size: 1.3rem; font-weight: 700; color: var(--dark-brown); }
        .course-stat .label { font-size: 0.75rem; color: #888; }
        
        .course-meta { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .course-meta span { font-size: 0.8rem; color: #666; background: var(--light-gray); padding: 5px 10px; border-radius: 5px; }
        
        .course-actions { display: flex; gap: 10px; }
        .course-actions button { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s; font-size: 0.9rem; }
        .btn-view { background: var(--green); color: white; }
        .btn-view:hover { background: var(--dark-green); }
        .btn-edit { background: var(--beige); color: var(--dark-brown); }
        .btn-edit:hover { background: #d9cab3; }
        .btn-delete { background: #f8d7da; color: #721c24; }
        .btn-delete:hover { background: #f1b0b7; }
        
        /* Create Form */
        .form-card { background: white; border-radius: 15px; padding: 30px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .form-card h2 { color: var(--dark-brown); margin-bottom: 20px; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--dark-brown); font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid var(--beige); border-radius: 10px; font-size: 1rem; transition: all 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--green); }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group small { color: #888; font-size: 0.85rem; margin-top: 5px; display: block; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        
        .btn { padding: 12px 25px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 1rem; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--green); color: white; }
        .btn-primary:hover { background: var(--dark-green); }
        .btn-secondary { background: var(--beige); color: var(--dark-brown); }
        .btn-secondary:hover { background: #d9cab3; }
        
        .score-input-wrapper { position: relative; }
        .score-input-wrapper input { padding-right: 50px; }
        .score-suffix { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #888; font-weight: 500; }
        
        .code-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .code-tab { padding: 10px 20px; background: var(--beige); border: none; cursor: pointer; border-radius: 8px 8px 0 0; }
        .code-tab.active { background: #2d2d2d; color: white; }
        .code-editor { background: #2d2d2d; border-radius: 0 10px 10px 10px; padding: 15px; }
        .code-editor textarea { width: 100%; min-height: 200px; background: transparent; border: none; color: #f8f8f2; font-family: 'Courier New', monospace; font-size: 14px; resize: vertical; }
        .code-editor textarea:focus { outline: none; }
        
        .module-list { margin-top: 15px; }
        .module-item { display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--light-gray); border-radius: 8px; margin-bottom: 10px; }
        .module-item span { flex: 1; }
        .module-item button { background: none; border: none; cursor: pointer; font-size: 1.1rem; }
        .add-module { display: flex; gap: 10px; }
        .add-module input { flex: 1; }
        
        .actions { display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px; }
        
        .empty-state { text-align: center; padding: 60px 20px; background: white; border-radius: 15px; }
        .empty-state .icon { font-size: 4rem; margin-bottom: 15px; }
        .empty-state p { color: #888; margin-bottom: 20px; }
        
        .loading { text-align: center; padding: 60px; }
        .spinner { width: 50px; height: 50px; border: 4px solid var(--beige); border-top: 4px solid var(--green); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media (max-width: 768px) {
            .form-row, .form-row-3 { grid-template-columns: 1fr; }
            .courses-grid { grid-template-columns: 1fr; }
            .tabs { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö Gestion des Cours</h1>
            <a href="instructor-dashboard.html" class="back-btn">‚Üê Retour au Dashboard</a>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('list')">üìã Mes Cours</button>
            <button class="tab" onclick="showTab('create')">‚ûï Cr√©er un Cours</button>
        </div>

        <div id="message" class="message"></div>

        <!-- Courses List -->
        <div id="list-section" class="section active">
            <div id="courses-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Chargement des cours...</p>
                </div>
            </div>
        </div>

        <!-- Create Course -->
        <div id="create-section" class="section">
            <div class="form-card">
                <h2>üìã Informations de base</h2>
                <div class="form-group">
                    <label for="title">Titre du cours *</label>
                    <input type="text" id="title" placeholder="Ex: JavaScript pour d√©butants">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="category">Cat√©gorie</label>
                        <select id="category">
                            <option value="">Chargement...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="price">Prix (‚Ç¨)</label>
                        <input type="number" id="price" placeholder="0 = Gratuit" min="0">
                    </div>
                </div>
                <div class="form-row-3">
                    <div class="form-group">
                        <label for="level">Niveau</label>
                        <select id="level">
                            <option value="debutant">D√©butant</option>
                            <option value="intermediaire">Interm√©diaire</option>
                            <option value="avance">Avanc√©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="duration">Dur√©e estim√©e</label>
                        <input type="text" id="duration" placeholder="Ex: 10 heures">
                    </div>
                    <div class="form-group">
                        <label for="min-score">Score minimum r√©ussite</label>
                        <div class="score-input-wrapper">
                            <input type="number" id="min-score" value="70" min="0" max="100">
                            <span class="score-suffix">%</span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" placeholder="D√©crivez votre cours..."></textarea>
                </div>
            </div>

            <div class="form-card">
                <h2>üíª Contenu du cours (Code)</h2>
                <div class="code-tabs">
                    <button class="code-tab active" onclick="showCodeTab('html')">HTML</button>
                    <button class="code-tab" onclick="showCodeTab('css')">CSS</button>
                    <button class="code-tab" onclick="showCodeTab('js')">JavaScript</button>
                </div>
                <div class="code-editor">
                    <textarea id="code-html" placeholder="<!-- Votre code HTML ici -->"></textarea>
                    <textarea id="code-css" style="display:none" placeholder="/* Votre code CSS ici */"></textarea>
                    <textarea id="code-js" style="display:none" placeholder="// Votre code JavaScript ici"></textarea>
                </div>
            </div>

            <div class="form-card">
                <h2>üìñ Modules du cours</h2>
                <div class="add-module">
                    <input type="text" id="module-title" placeholder="Titre du module">
                    <input type="text" id="module-duration" placeholder="Dur√©e" style="width: 120px;">
                    <button class="btn btn-secondary" onclick="addModule()">+ Ajouter</button>
                </div>
                <div class="module-list" id="module-list"></div>
            </div>

            <div class="form-card">
                <h2>üé• Vid√©os</h2>
                <div class="add-module">
                    <input type="text" id="video-title" placeholder="Titre de la vid√©o">
                    <input type="url" id="video-url" placeholder="URL YouTube/Vimeo">
                    <button class="btn btn-secondary" onclick="addVideo()">+ Ajouter</button>
                </div>
                <div class="module-list" id="video-list"></div>
            </div>

            <div class="actions">
                <button class="btn btn-secondary" onclick="saveDraft()">üíæ Brouillon</button>
                <button class="btn btn-primary" onclick="publishCourse()">üöÄ Publier</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { getFirestore, collection, query, getDocs, doc, addDoc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAVO1P9v-IBsyxF_80vQvZDlR5tIqh878U",
            authDomain: "learncentric.firebaseapp.com",
            projectId: "learncentric",
            storageBucket: "learncentric.firebasestorage.app",
            messagingSenderId: "1083770541694",
            appId: "1:1083770541694:web:b8dbcd7852ca7d9c8fea2f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseDb = db;
        window.firebaseCollection = collection;
        window.firebaseQuery = query;
        window.firebaseGetDocs = getDocs;
        window.firebaseDoc = doc;
        window.firebaseAddDoc = addDoc;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseGetDoc = getDoc;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                await loadCategories();
                await loadCourses();
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadCategories() {
            try {
                const categoriesQuery = query(collection(db, "categories"));
                const snapshot = await getDocs(categoriesQuery);
                
                window.categoriesMap = {};
                const select = document.getElementById('category');
                select.innerHTML = '<option value="">S√©lectionner...</option>';
                
                snapshot.forEach(doc => {
                    const cat = doc.data();
                    window.categoriesMap[doc.id] = { name: cat.name, icon: cat.icon || 'üìö' };
                    select.innerHTML += `<option value="${doc.id}">${cat.icon || 'üìö'} ${cat.name}</option>`;
                });
                
                if (snapshot.empty) {
                    select.innerHTML = `
                        <option value="">S√©lectionner...</option>
                        <option value="developpement">üíª D√©veloppement</option>
                        <option value="design">üé® Design</option>
                        <option value="business">üìä Business</option>
                        <option value="compliance">‚öñÔ∏è Compliance</option>
                    `;
                }
            } catch (error) {
                console.error('Erreur cat√©gories:', error);
            }
        }

        async function loadCourses() {
            try {
                const coursesQuery = query(collection(db, "courses"));
                const snapshot = await getDocs(coursesQuery);
                
                window.allCourses = [];
                snapshot.forEach(doc => {
                    window.allCourses.push({ id: doc.id, ...doc.data() });
                });
                
                displayCourses();
            } catch (error) {
                console.error('Erreur cours:', error);
            }
        }

        window.loadCategories = loadCategories;
        window.loadCourses = loadCourses;
    </script>

    <script>
        window.modules = [];
        window.videos = [];
        window.editingCourseId = null;

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            
            event.currentTarget.classList.add('active');
            document.getElementById(tab + '-section').classList.add('active');
            
            if (tab === 'create' && !window.editingCourseId) {
                resetForm();
            }
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = 'message ' + type;
            window.scrollTo(0, 0);
            setTimeout(() => { msg.className = 'message'; }, 4000);
        }

        function getCategoryName(categoryId) {
            if (window.categoriesMap && window.categoriesMap[categoryId]) {
                const cat = window.categoriesMap[categoryId];
                return cat.icon + ' ' + cat.name;
            }
            return categoryId || '-';
        }

        function displayCourses() {
            const container = document.getElementById('courses-container');
            const courses = window.allCourses || [];
            
            if (courses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìö</div>
                        <h3>Aucun cours</h3>
                        <p>Cr√©ez votre premier cours d√®s maintenant</p>
                        <button class="btn btn-primary" onclick="showTab('create')">‚ûï Cr√©er un cours</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="courses-grid">
                    ${courses.map(course => `
                        <div class="course-card">
                            <div class="course-header">
                                <span class="course-status ${course.status === 'published' ? 'status-published' : 'status-draft'}">
                                    ${course.status === 'published' ? '‚úì Publi√©' : '‚è≥ Brouillon'}
                                </span>
                                <h3>${course.title || 'Sans titre'}</h3>
                                <p>${getCategoryName(course.category)}</p>
                            </div>
                            <div class="course-body">
                                <div class="course-stats">
                                    <div class="course-stat">
                                        <div class="number">${course.modules?.length || 0}</div>
                                        <div class="label">Modules</div>
                                    </div>
                                    <div class="course-stat">
                                        <div class="number">${course.videos?.length || 0}</div>
                                        <div class="label">Vid√©os</div>
                                    </div>
                                    <div class="course-stat">
                                        <div class="number">${course.minScore || 70}%</div>
                                        <div class="label">Score min</div>
                                    </div>
                                </div>
                                <div class="course-meta">
                                    <span>‚è±Ô∏è ${course.duration || 'Non d√©finie'}</span>
                                    <span>üìä ${course.level || 'Tous niveaux'}</span>
                                    <span>üí∞ ${course.price ? course.price + '‚Ç¨' : 'Gratuit'}</span>
                                </div>
                                <div class="course-actions">
                                    <button class="btn-view" onclick="viewCourse('${course.id}')">üëÅÔ∏è Voir</button>
                                    <button class="btn-edit" onclick="editCourse('${course.id}')">‚úèÔ∏è Modifier</button>
                                    <button class="btn-delete" onclick="deleteCourse('${course.id}')">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function viewCourse(courseId) {
            window.location.href = 'view-course.html?id=' + courseId;
        }

        async function editCourse(courseId) {
            const course = window.allCourses.find(c => c.id === courseId);
            if (!course) return;
            
            window.editingCourseId = courseId;
            
            document.getElementById('title').value = course.title || '';
            document.getElementById('category').value = course.category || '';
            document.getElementById('price').value = course.price || '';
            document.getElementById('level').value = course.level || 'debutant';
            document.getElementById('duration').value = course.duration || '';
            document.getElementById('min-score').value = course.minScore || 70;
            document.getElementById('description').value = course.description || '';
            document.getElementById('code-html').value = course.codeHtml || '';
            document.getElementById('code-css').value = course.codeCss || '';
            document.getElementById('code-js').value = course.codeJs || '';
            
            window.modules = course.modules || [];
            window.videos = course.videos || [];
            renderModules();
            renderVideos();
            
            showTab('create');
            document.querySelectorAll('.tab')[1].click();
        }

        async function deleteCourse(courseId) {
            if (!confirm('Supprimer ce cours ?')) return;
            
            try {
                await window.firebaseDeleteDoc(window.firebaseDoc(window.firebaseDb, "courses", courseId));
                showMessage('‚úÖ Cours supprim√©', 'success');
                await window.loadCourses();
            } catch (error) {
                showMessage('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        function showCodeTab(tab) {
            document.querySelectorAll('.code-tab').forEach(t => t.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            document.getElementById('code-html').style.display = tab === 'html' ? 'block' : 'none';
            document.getElementById('code-css').style.display = tab === 'css' ? 'block' : 'none';
            document.getElementById('code-js').style.display = tab === 'js' ? 'block' : 'none';
        }

        function addModule() {
            const title = document.getElementById('module-title').value.trim();
            const duration = document.getElementById('module-duration').value.trim();
            if (!title) return;
            
            window.modules.push({ title, duration });
            renderModules();
            document.getElementById('module-title').value = '';
            document.getElementById('module-duration').value = '';
        }

        function renderModules() {
            document.getElementById('module-list').innerHTML = window.modules.map((m, i) => `
                <div class="module-item">
                    <span>üìñ ${m.title} ${m.duration ? '(' + m.duration + ')' : ''}</span>
                    <button onclick="window.modules.splice(${i},1);renderModules();">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function addVideo() {
            const title = document.getElementById('video-title').value.trim();
            const url = document.getElementById('video-url').value.trim();
            if (!title || !url) return;
            
            window.videos.push({ title, url });
            renderVideos();
            document.getElementById('video-title').value = '';
            document.getElementById('video-url').value = '';
        }

        function renderVideos() {
            document.getElementById('video-list').innerHTML = window.videos.map((v, i) => `
                <div class="module-item">
                    <span>üé• ${v.title}</span>
                    <button onclick="window.videos.splice(${i},1);renderVideos();">üóëÔ∏è</button>
                </div>
            `).join('');
        }

        function getCourseData(status) {
            return {
                title: document.getElementById('title').value.trim(),
                category: document.getElementById('category').value,
                price: parseFloat(document.getElementById('price').value) || 0,
                level: document.getElementById('level').value,
                duration: document.getElementById('duration').value.trim(),
                minScore: parseInt(document.getElementById('min-score').value) || 70,
                description: document.getElementById('description').value.trim(),
                codeHtml: document.getElementById('code-html').value,
                codeCss: document.getElementById('code-css').value,
                codeJs: document.getElementById('code-js').value,
                modules: window.modules,
                videos: window.videos,
                status: status,
                instructorId: window.currentUser.uid,
                instructorName: window.currentUser.displayName || window.currentUser.email,
                updatedAt: new Date().toISOString()
            };
        }

        async function saveDraft() {
            const title = document.getElementById('title').value.trim();
            if (!title) { showMessage('‚ùå Titre requis', 'error'); return; }
            
            try {
                const data = getCourseData('draft');
                
                if (window.editingCourseId) {
                    await window.firebaseUpdateDoc(window.firebaseDoc(window.firebaseDb, "courses", window.editingCourseId), data);
                } else {
                    data.createdAt = new Date().toISOString();
                    const ref = await window.firebaseAddDoc(window.firebaseCollection(window.firebaseDb, "courses"), data);
                    window.editingCourseId = ref.id;
                }
                
                showMessage('‚úÖ Brouillon enregistr√© !', 'success');
                await window.loadCourses();
            } catch (error) {
                showMessage('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        async function publishCourse() {
            const title = document.getElementById('title').value.trim();
            if (!title) { showMessage('‚ùå Titre requis', 'error'); return; }
            
            try {
                const data = getCourseData('published');
                
                if (window.editingCourseId) {
                    await window.firebaseUpdateDoc(window.firebaseDoc(window.firebaseDb, "courses", window.editingCourseId), data);
                } else {
                    data.createdAt = new Date().toISOString();
                    await window.firebaseAddDoc(window.firebaseCollection(window.firebaseDb, "courses"), data);
                }
                
                showMessage('‚úÖ Cours publi√© !', 'success');
                resetForm();
                await window.loadCourses();
                document.querySelectorAll('.tab')[0].click();
            } catch (error) {
                showMessage('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        function resetForm() {
            window.editingCourseId = null;
            window.modules = [];
            window.videos = [];
            
            document.getElementById('title').value = '';
            document.getElementById('category').value = '';
            document.getElementById('price').value = '';
            document.getElementById('level').value = 'debutant';
            document.getElementById('duration').value = '';
            document.getElementById('min-score').value = '70';
            document.getElementById('description').value = '';
            document.getElementById('code-html').value = '';
            document.getElementById('code-css').value = '';
            document.getElementById('code-js').value = '';
            
            renderModules();
            renderVideos();
        }
    </script>
</body>
</html>
