<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Utilisateurs - LearningHub</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --brown: #8B6F47; --dark-brown: #6B5A3B; --beige: #E8DCC4; --light-gray: #F5F5F0; --green: #6B9F7F; --dark-green: #5A8A6E; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--light-gray); min-height: 100vh; padding: 20px; }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { color: var(--dark-brown); display: flex; align-items: center; gap: 10px; }
        .back-btn { background: var(--beige); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; color: var(--dark-brown); font-weight: 500; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
        .back-btn:hover { background: #d9cab3; }
        
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-card h3 { font-size: 1.8rem; color: var(--dark-brown); }
        .stat-card p { color: #888; font-size: 0.85rem; }
        
        .section { background: white; border-radius: 15px; padding: 25px; margin-bottom: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .section-header h2 { color: var(--dark-brown); font-size: 1.2rem; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--green); color: white; }
        .btn-primary:hover { background: var(--dark-green); }
        .btn-secondary { background: var(--beige); color: var(--dark-brown); }
        .btn-secondary:hover { background: #d9cab3; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-small { padding: 6px 12px; font-size: 0.85rem; }
        
        /* Search and filters */
        .filters { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; }
        .filters input, .filters select { padding: 10px 15px; border: 2px solid var(--beige); border-radius: 8px; font-size: 0.95rem; }
        .filters input { flex: 1; min-width: 200px; }
        .filters input:focus, .filters select:focus { outline: none; border-color: var(--green); }
        
        /* Table */
        .table-container { overflow-x: auto; }
        .table { width: 100%; border-collapse: collapse; min-width: 800px; }
        .table th, .table td { padding: 15px; text-align: left; border-bottom: 1px solid var(--beige); }
        .table th { color: var(--dark-brown); font-weight: 600; background: var(--light-gray); position: sticky; top: 0; }
        .table tr:hover { background: var(--light-gray); }
        
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 40px; height: 40px; background: var(--green); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .user-details h4 { font-size: 0.95rem; color: var(--dark-brown); }
        .user-details p { font-size: 0.8rem; color: #888; }
        
        .role-badge { padding: 4px 10px; border-radius: 15px; font-size: 0.75rem; font-weight: 500; }
        .role-student { background: #e3f2fd; color: #1976d2; }
        .role-instructor { background: #fff3e0; color: #f57c00; }
        .role-admin { background: #fce4ec; color: #c2185b; }
        
        .assigned-count { background: var(--light-gray); padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; }
        
        .action-buttons { display: flex; gap: 8px; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 20px; width: 100%; max-width: 700px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 25px; background: var(--light-gray); border-bottom: 1px solid var(--beige); }
        .modal-header h2 { color: var(--dark-brown); margin-bottom: 5px; }
        .modal-header p { color: #888; font-size: 0.9rem; }
        .modal-body { padding: 25px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 20px 25px; background: var(--light-gray); border-top: 1px solid var(--beige); display: flex; gap: 15px; justify-content: flex-end; }
        
        /* Assignment lists */
        .assignment-section { margin-bottom: 25px; }
        .assignment-section h3 { font-size: 1rem; color: var(--dark-brown); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .assignment-list { border: 2px solid var(--beige); border-radius: 10px; max-height: 250px; overflow-y: auto; }
        .assignment-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; border-bottom: 1px solid var(--beige); cursor: pointer; transition: all 0.2s; }
        .assignment-item:last-child { border-bottom: none; }
        .assignment-item:hover { background: var(--light-gray); }
        .assignment-item.selected { background: var(--green); color: white; }
        .assignment-checkbox { width: 20px; height: 20px; border: 2px solid var(--beige); border-radius: 4px; display: flex; align-items: center; justify-content: center; background: white; flex-shrink: 0; font-size: 0.8rem; }
        .assignment-item.selected .assignment-checkbox { background: white; color: var(--green); border-color: white; }
        .assignment-info { flex: 1; }
        .assignment-info h4 { font-size: 0.9rem; }
        .assignment-info p { font-size: 0.8rem; opacity: 0.8; }
        
        /* Form */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--dark-brown); font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 12px 15px; border: 2px solid var(--beige); border-radius: 10px; font-size: 1rem; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--green); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .loading { text-align: center; padding: 40px; color: #888; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--beige); border-top: 4px solid var(--green); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .empty-state { text-align: center; padding: 40px; color: #888; }
        
        .message { padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; display: none; }
        .message.success { background: #d4edda; color: #155724; display: block; }
        .message.error { background: #f8d7da; color: #721c24; display: block; }
        
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .filters { flex-direction: column; }
            .filters input { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üë• Gestion des Utilisateurs</h1>
            <a href="instructor-dashboard.html" class="back-btn">‚Üê Retour au Dashboard</a>
        </div>

        <div id="message" class="message"></div>

        <!-- Stats -->
        <div class="stats-row">
            <div class="stat-card">
                <h3 id="stat-total">0</h3>
                <p>Total utilisateurs</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-students">0</h3>
                <p>√âtudiants</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-instructors">0</h3>
                <p>Formateurs</p>
            </div>
            <div class="stat-card">
                <h3 id="stat-active">0</h3>
                <p>Actifs ce mois</p>
            </div>
        </div>

        <!-- Users List -->
        <div class="section">
            <div class="section-header">
                <h2>üìã Liste des Utilisateurs</h2>
                <button class="btn btn-primary" onclick="openAddUserModal()">‚ûï Ajouter un utilisateur</button>
            </div>

            <div class="filters">
                <input type="text" id="search-input" placeholder="üîç Rechercher par nom ou email..." onkeyup="filterUsers()">
                <select id="role-filter" onchange="filterUsers()">
                    <option value="">Tous les r√¥les</option>
                    <option value="student">√âtudiants</option>
                    <option value="instructor">Formateurs</option>
                    <option value="admin">Admins</option>
                </select>
            </div>

            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Utilisateur</th>
                            <th>R√¥le</th>
                            <th>Cours assign√©s</th>
                            <th>Programmes</th>
                            <th>Progression</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table">
                        <tr>
                            <td colspan="6">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <p>Chargement des utilisateurs...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Assign Courses Modal -->
    <div class="modal" id="assign-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìö Assigner des formations</h2>
                <p>Utilisateur: <strong id="assign-user-name"></strong></p>
            </div>
            <div class="modal-body">
                <div class="assignment-section">
                    <h3>üìö Cours disponibles</h3>
                    <div class="assignment-list" id="courses-list"></div>
                </div>
                <div class="assignment-section">
                    <h3>üéì Programmes disponibles</h3>
                    <div class="assignment-list" id="programs-list"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAssignModal()">Annuler</button>
                <button class="btn btn-primary" onclick="saveAssignments()">üíæ Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal" id="add-user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Ajouter un utilisateur</h2>
                <p>Cr√©er un nouvel utilisateur dans le syst√®me</p>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nom complet</label>
                        <input type="text" id="new-user-name" placeholder="Jean Dupont">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="new-user-email" placeholder="jean@example.com">
                    </div>
                </div>
                <div class="form-group">
                    <label>R√¥le</label>
                    <select id="new-user-role">
                        <option value="student">√âtudiant</option>
                        <option value="instructor">Formateur</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <p style="color: #888; font-size: 0.85rem; margin-top: 15px;">
                    ‚ÑπÔ∏è L'utilisateur devra cr√©er son mot de passe via la page de connexion (inscription ou "mot de passe oubli√©").
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddUserModal()">Annuler</button>
                <button class="btn btn-primary" onclick="addUser()">‚ûï Ajouter</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { getFirestore, collection, query, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAVO1P9v-IBsyxF_80vQvZDlR5tIqh878U",
            authDomain: "learncentric.firebaseapp.com",
            projectId: "learncentric",
            storageBucket: "learncentric.firebasestorage.app",
            messagingSenderId: "1083770541694",
            appId: "1:1083770541694:web:b8dbcd7852ca7d9c8fea2f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseDb = db;
        window.collection = collection;
        window.query = query;
        window.getDocs = getDocs;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                await loadAllData();
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadAllData() {
            try {
                // Load users
                const usersSnapshot = await getDocs(collection(db, "users"));
                window.allUsers = [];
                usersSnapshot.forEach(doc => {
                    window.allUsers.push({ id: doc.id, ...doc.data() });
                });

                // Load courses
                const coursesSnapshot = await getDocs(collection(db, "courses"));
                window.allCourses = [];
                coursesSnapshot.forEach(doc => {
                    window.allCourses.push({ id: doc.id, ...doc.data() });
                });

                // Load programs
                const programsSnapshot = await getDocs(collection(db, "programs"));
                window.allPrograms = [];
                programsSnapshot.forEach(doc => {
                    window.allPrograms.push({ id: doc.id, ...doc.data() });
                });

                // Update stats
                const students = window.allUsers.filter(u => u.role === 'student' || !u.role);
                const instructors = window.allUsers.filter(u => u.role === 'instructor' || u.role === 'admin');
                
                document.getElementById('stat-total').textContent = window.allUsers.length;
                document.getElementById('stat-students').textContent = students.length;
                document.getElementById('stat-instructors').textContent = instructors.length;
                document.getElementById('stat-active').textContent = window.allUsers.length; // Simplified

                displayUsers(window.allUsers);
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('Erreur lors du chargement', 'error');
            }
        }

        window.loadAllData = loadAllData;
    </script>

    <script>
        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = 'message ' + type;
            window.scrollTo(0, 0);
            setTimeout(() => { msg.className = 'message'; }, 5000);
        }

        function displayUsers(users) {
            const tbody = document.getElementById('users-table');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state">Aucun utilisateur trouv√©</div></td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                const assignedCourses = user.assignedCourses?.length || 0;
                const assignedPrograms = user.assignedPrograms?.length || 0;
                const role = user.role || 'student';
                const roleLabels = { student: '√âtudiant', instructor: 'Formateur', admin: 'Admin' };
                
                // Calculate progress
                let totalProgress = 0;
                let coursesWithProgress = 0;
                if (user.progress) {
                    Object.values(user.progress).forEach(p => {
                        totalProgress += p.percent || 0;
                        coursesWithProgress++;
                    });
                }
                const avgProgress = coursesWithProgress > 0 ? Math.round(totalProgress / coursesWithProgress) : 0;

                return `
                    <tr data-role="${role}" data-name="${(user.name || '').toLowerCase()}" data-email="${(user.email || '').toLowerCase()}">
                        <td>
                            <div class="user-info">
                                <div class="user-avatar">${(user.name || user.email || '?').charAt(0).toUpperCase()}</div>
                                <div class="user-details">
                                    <h4>${user.name || 'Sans nom'}</h4>
                                    <p>${user.email || '-'}</p>
                                </div>
                            </div>
                        </td>
                        <td><span class="role-badge role-${role}">${roleLabels[role]}</span></td>
                        <td><span class="assigned-count">üìö ${assignedCourses}</span></td>
                        <td><span class="assigned-count">üéì ${assignedPrograms}</span></td>
                        <td>${avgProgress}%</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-small" onclick="openAssignModal('${user.id}')">üìù Assigner</button>
                                <button class="btn btn-small" style="background:#e3f2fd;color:#1976d2;" onclick="editUser('${user.id}')">‚úèÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterUsers() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const roleFilter = document.getElementById('role-filter').value;
            
            const rows = document.querySelectorAll('#users-table tr[data-role]');
            
            rows.forEach(row => {
                const name = row.getAttribute('data-name');
                const email = row.getAttribute('data-email');
                const role = row.getAttribute('data-role');
                
                const matchesSearch = name.includes(search) || email.includes(search);
                const matchesRole = !roleFilter || role === roleFilter;
                
                row.style.display = matchesSearch && matchesRole ? '' : 'none';
            });
        }

        // Assign Modal
        let currentUserId = null;
        let selectedCourses = [];
        let selectedPrograms = [];

        function openAssignModal(userId) {
            const user = window.allUsers.find(u => u.id === userId);
            if (!user) return;
            
            currentUserId = userId;
            selectedCourses = [...(user.assignedCourses || [])];
            selectedPrograms = [...(user.assignedPrograms || [])];
            
            document.getElementById('assign-user-name').textContent = user.name || user.email;
            
            // Display courses
            const coursesList = document.getElementById('courses-list');
            coursesList.innerHTML = window.allCourses.map(course => {
                const isSelected = selectedCourses.includes(course.id);
                return `
                    <div class="assignment-item ${isSelected ? 'selected' : ''}" onclick="toggleCourseAssignment('${course.id}', this)">
                        <div class="assignment-checkbox">${isSelected ? '‚úì' : ''}</div>
                        <div class="assignment-info">
                            <h4>${course.title || 'Sans titre'}</h4>
                            <p>${course.category || 'Non cat√©goris√©'} ‚Ä¢ ${course.duration || '-'}</p>
                        </div>
                    </div>
                `;
            }).join('') || '<div class="empty-state">Aucun cours disponible</div>';
            
            // Display programs
            const programsList = document.getElementById('programs-list');
            programsList.innerHTML = window.allPrograms.map(program => {
                const isSelected = selectedPrograms.includes(program.id);
                return `
                    <div class="assignment-item ${isSelected ? 'selected' : ''}" onclick="toggleProgramAssignment('${program.id}', this)">
                        <div class="assignment-checkbox">${isSelected ? '‚úì' : ''}</div>
                        <div class="assignment-info">
                            <h4>${program.title || 'Sans titre'}</h4>
                            <p>${program.courses?.length || 0} cours</p>
                        </div>
                    </div>
                `;
            }).join('') || '<div class="empty-state">Aucun programme disponible</div>';
            
            document.getElementById('assign-modal').classList.add('show');
        }

        function closeAssignModal() {
            document.getElementById('assign-modal').classList.remove('show');
            currentUserId = null;
        }

        function toggleCourseAssignment(courseId, element) {
            const index = selectedCourses.indexOf(courseId);
            if (index > -1) {
                selectedCourses.splice(index, 1);
                element.classList.remove('selected');
                element.querySelector('.assignment-checkbox').textContent = '';
            } else {
                selectedCourses.push(courseId);
                element.classList.add('selected');
                element.querySelector('.assignment-checkbox').textContent = '‚úì';
            }
        }

        function toggleProgramAssignment(programId, element) {
            const index = selectedPrograms.indexOf(programId);
            if (index > -1) {
                selectedPrograms.splice(index, 1);
                element.classList.remove('selected');
                element.querySelector('.assignment-checkbox').textContent = '';
            } else {
                selectedPrograms.push(programId);
                element.classList.add('selected');
                element.querySelector('.assignment-checkbox').textContent = '‚úì';
            }
        }

        async function saveAssignments() {
            if (!currentUserId) return;
            
            try {
                const userRef = window.doc(window.firebaseDb, "users", currentUserId);
                await window.updateDoc(userRef, {
                    assignedCourses: selectedCourses,
                    assignedPrograms: selectedPrograms
                });
                
                showMessage('‚úÖ Formations assign√©es avec succ√®s !', 'success');
                closeAssignModal();
                await window.loadAllData();
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        // Add User Modal
        function openAddUserModal() {
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-email').value = '';
            document.getElementById('new-user-role').value = 'student';
            document.getElementById('add-user-modal').classList.add('show');
        }

        function closeAddUserModal() {
            document.getElementById('add-user-modal').classList.remove('show');
        }

        async function addUser() {
            const name = document.getElementById('new-user-name').value.trim();
            const email = document.getElementById('new-user-email').value.trim();
            const role = document.getElementById('new-user-role').value;
            
            if (!name || !email) {
                showMessage('‚ùå Veuillez remplir tous les champs', 'error');
                return;
            }
            
            try {
                // Create a unique ID based on email
                const oderId = email.replace(/[^a-zA-Z0-9]/g, '_');
                
                const userRef = window.doc(window.firebaseDb, "users", oderId);
                await window.setDoc(userRef, {
                    name: name,
                    email: email,
                    role: role,
                    assignedCourses: [],
                    assignedPrograms: [],
                    progress: {},
                    createdAt: new Date().toISOString()
                });
                
                showMessage('‚úÖ Utilisateur ajout√© !', 'success');
                closeAddUserModal();
                await window.loadAllData();
            } catch (error) {
                console.error('Erreur:', error);
                showMessage('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        function editUser(userId) {
            // TODO: Open edit modal
            alert('Fonctionnalit√© √† venir : modifier l\'utilisateur');
        }

        // Close modals on outside click
        document.getElementById('assign-modal').addEventListener('click', function(e) {
            if (e.target === this) closeAssignModal();
        });
        document.getElementById('add-user-modal').addEventListener('click', function(e) {
            if (e.target === this) closeAddUserModal();
        });
    </script>
</body>
</html>
