<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programmes - LearningHub</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --brown: #8B6F47; --dark-brown: #6B5A3B; --beige: #E8DCC4; --light-gray: #F5F5F0; --green: #6B9F7F; --dark-green: #5A8A6E; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--light-gray); min-height: 100vh; padding: 20px; }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { color: var(--dark-brown); display: flex; align-items: center; gap: 10px; }
        .back-btn { background: var(--beige); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; color: var(--dark-brown); font-weight: 500; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
        .back-btn:hover { background: #d9cab3; }
        
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; }
        .tab { padding: 12px 25px; background: white; border: 2px solid var(--beige); border-radius: 10px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
        .tab.active { background: var(--green); color: white; border-color: var(--green); }
        .tab:hover:not(.active) { background: var(--beige); }
        
        .section { display: none; }
        .section.active { display: block; }
        
        .message { padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; display: none; }
        .message.success { background: #d4edda; color: #155724; display: block; }
        .message.error { background: #f8d7da; color: #721c24; display: block; }
        
        .card { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .card h2 { color: var(--dark-brown); margin-bottom: 20px; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--dark-brown); font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid var(--beige); border-radius: 10px; font-size: 1rem; transition: all 0.3s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--green); }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group small { color: #888; font-size: 0.85rem; margin-top: 5px; display: block; }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .btn { padding: 12px 25px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 1rem; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--green); color: white; }
        .btn-primary:hover { background: var(--dark-green); }
        .btn-secondary { background: var(--beige); color: var(--dark-brown); }
        .btn-secondary:hover { background: #d9cab3; }
        
        .programs-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        
        .program-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: all 0.3s; }
        .program-card:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        .program-header { background: linear-gradient(135deg, var(--brown), var(--dark-brown)); color: white; padding: 25px; position: relative; }
        .program-header h3 { font-size: 1.2rem; margin-bottom: 8px; }
        .program-header p { opacity: 0.9; font-size: 0.9rem; }
        .program-status { position: absolute; top: 15px; right: 15px; padding: 5px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 500; background: rgba(255,255,255,0.2); }
        
        .program-body { padding: 20px; }
        .program-courses { margin-bottom: 15px; }
        .program-courses h4 { font-size: 0.85rem; color: #888; margin-bottom: 10px; }
        .course-tag { display: inline-block; background: var(--light-gray); padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; margin: 3px; }
        .doc-tag { display: inline-block; background: #e7f1ff; padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; margin: 3px; color: #004085; }
        
        .program-meta { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .program-meta span { font-size: 0.8rem; color: #666; background: var(--light-gray); padding: 5px 10px; border-radius: 5px; }
        .program-meta span.deadline { background: #fff3cd; color: #856404; }
        .program-meta span.deadline-passed { background: #f8d7da; color: #721c24; }
        
        .program-actions { display: flex; gap: 10px; }
        .program-actions button { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; font-size: 0.9rem; }
        .btn-edit { background: var(--beige); color: var(--dark-brown); }
        .btn-edit:hover { background: #d9cab3; }
        .btn-delete { background: #f8d7da; color: #721c24; }
        .btn-delete:hover { background: #f1b0b7; }
        
        .courses-list, .documents-list { max-height: 300px; overflow-y: auto; border: 2px solid var(--beige); border-radius: 10px; padding: 10px; }
        .course-item, .document-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .course-item:hover, .document-item:hover { background: var(--light-gray); }
        .course-item.selected, .document-item.selected { background: #d4edda; }
        .course-item input, .document-item input { width: 18px; height: 18px; cursor: pointer; }
        .course-item .info, .document-item .info { flex: 1; }
        .course-item .title, .document-item .title { font-weight: 500; color: var(--dark-brown); }
        .course-item .meta, .document-item .meta { font-size: 0.8rem; color: #888; }
        
        .selected-courses, .selected-documents { margin-top: 15px; }
        .selected-courses h4, .selected-documents h4 { font-size: 0.9rem; color: var(--dark-brown); margin-bottom: 10px; }
        .selected-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .selected-tag { background: var(--green); color: white; padding: 5px 12px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; }
        .selected-tag.doc-selected { background: #004085; }
        .selected-tag button { background: none; border: none; color: white; cursor: pointer; font-size: 1rem; }
        
        .actions { display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px; }
        
        .empty-state { text-align: center; padding: 60px 20px; background: white; border-radius: 15px; }
        .empty-state .icon { font-size: 4rem; margin-bottom: 15px; }
        .empty-state p { color: #888; margin-bottom: 20px; }
        
        .loading { text-align: center; padding: 60px; }
        .spinner { width: 50px; height: 50px; border: 4px solid var(--beige); border-top: 4px solid var(--green); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .programs-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Programmes de Formation</h1>
            <a href="instructor-dashboard.html" class="back-btn">‚Üê Retour</a>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('list')">üìã Mes Programmes</button>
            <button class="tab" onclick="showTab('create')">‚ûï Cr√©er un Programme</button>
        </div>

        <div id="message" class="message"></div>

        <!-- Programs List -->
        <div id="list-section" class="section active">
            <div id="programs-container">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Chargement...</p>
                </div>
            </div>
        </div>

        <!-- Create Program -->
        <div id="create-section" class="section">
            <div class="card">
                <h2>üìã Informations du programme</h2>
                
                <div class="form-group">
                    <label>Titre du programme *</label>
                    <input type="text" id="title" placeholder="Ex: Parcours Compliance 2025">
                </div>
                
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="description" placeholder="D√©crivez ce programme..."></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>üìÖ Date limite (deadline)</label>
                        <input type="date" id="deadline">
                        <small>Date avant laquelle les √©tudiants doivent terminer</small>
                    </div>
                    <div class="form-group">
                        <label>‚è∞ Heure limite</label>
                        <input type="time" id="deadline-time" value="23:59">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìö Cours inclus</h2>
                <p style="color: #888; margin-bottom: 15px;">S√©lectionnez les cours √† inclure :</p>
                
                <div class="courses-list" id="courses-list">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
                
                <div class="selected-courses" id="selected-courses-container" style="display: none;">
                    <h4>üìã Cours s√©lectionn√©s :</h4>
                    <div class="selected-list" id="selected-list"></div>
                </div>
            </div>

            <!-- Section Documents -->
            <div class="card">
                <h2>üìÑ Documents associ√©s</h2>
                <p style="color: #888; margin-bottom: 15px;">S√©lectionnez les documents que l'√©tudiant devra consulter et accepter :</p>
                
                <div class="documents-list" id="documents-list">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
                
                <div class="selected-documents" id="selected-documents-container" style="display: none;">
                    <h4>üìÑ Documents s√©lectionn√©s :</h4>
                    <div class="selected-list" id="selected-docs-list"></div>
                </div>
            </div>

            <div class="actions">
                <button class="btn btn-secondary" onclick="saveDraft()">üíæ Brouillon</button>
                <button class="btn btn-primary" onclick="publishProgram()">üöÄ Publier</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { getFirestore, collection, query, getDocs, doc, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAVO1P9v-IBsyxF_80vQvZDlR5tIqh878U",
            authDomain: "learncentric.firebaseapp.com",
            projectId: "learncentric",
            storageBucket: "learncentric.firebasestorage.app",
            messagingSenderId: "1083770541694",
            appId: "1:1083770541694:web:b8dbcd7852ca7d9c8fea2f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.firebaseDb = db;
        window.collection = collection;
        window.getDocs = getDocs;
        window.doc = doc;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                await loadData();
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadData() {
            try {
                // Charger les cours
                const coursesSnapshot = await getDocs(collection(db, "courses"));
                window.allCourses = [];
                coursesSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.status === 'published') {
                        window.allCourses.push({ id: doc.id, ...data });
                    }
                });
                
                // Charger les documents
                const docsSnapshot = await getDocs(collection(db, "documents"));
                window.allDocuments = [];
                docsSnapshot.forEach(doc => {
                    window.allDocuments.push({ id: doc.id, ...doc.data() });
                });
                
                // Charger les programmes
                const programsSnapshot = await getDocs(collection(db, "programs"));
                window.allPrograms = [];
                programsSnapshot.forEach(doc => {
                    window.allPrograms.push({ id: doc.id, ...doc.data() });
                });
                
                displayCoursesList();
                displayDocumentsList();
                displayPrograms();
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        window.loadData = loadData;
    </script>

    <script>
        window.selectedCourses = [];
        window.selectedDocuments = [];
        window.editingProgramId = null;

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById(tab + '-section').classList.add('active');
            if (tab === 'create' && !window.editingProgramId) resetForm();
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = 'message ' + type;
            window.scrollTo(0, 0);
            setTimeout(() => { msg.className = 'message'; }, 4000);
        }

        // ==================== COURS ====================
        function displayCoursesList() {
            const container = document.getElementById('courses-list');
            const courses = window.allCourses || [];
            
            if (courses.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">Aucun cours publi√©</p>';
                return;
            }
            
            container.innerHTML = courses.map(course => `
                <div class="course-item ${window.selectedCourses.includes(course.id) ? 'selected' : ''}" onclick="toggleCourse('${course.id}')">
                    <input type="checkbox" ${window.selectedCourses.includes(course.id) ? 'checked' : ''}>
                    <div class="info">
                        <div class="title">${course.title}</div>
                        <div class="meta">${course.duration || '-'} ‚Ä¢ ${course.modules?.length || 0} modules</div>
                    </div>
                </div>
            `).join('');
        }

        function toggleCourse(courseId) {
            const index = window.selectedCourses.indexOf(courseId);
            if (index > -1) window.selectedCourses.splice(index, 1);
            else window.selectedCourses.push(courseId);
            displayCoursesList();
            updateSelectedCourses();
        }

        function updateSelectedCourses() {
            const container = document.getElementById('selected-courses-container');
            const list = document.getElementById('selected-list');
            
            if (window.selectedCourses.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            list.innerHTML = window.selectedCourses.map((id, i) => {
                const course = (window.allCourses || []).find(c => c.id === id);
                return course ? `<span class="selected-tag">${i + 1}. ${course.title} <button onclick="removeCourse('${id}')">&times;</button></span>` : '';
            }).join('');
        }

        function removeCourse(courseId) {
            window.selectedCourses = window.selectedCourses.filter(id => id !== courseId);
            displayCoursesList();
            updateSelectedCourses();
        }

        // ==================== DOCUMENTS ====================
        function displayDocumentsList() {
            const container = document.getElementById('documents-list');
            const documents = window.allDocuments || [];
            
            if (documents.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">Aucun document disponible. <a href="documents-management.html">Cr√©er un document</a></p>';
                return;
            }
            
            const cats = { 'policy': 'Politique', 'guide': 'Guide', 'form': 'Formulaire', 'certificate': 'Attestation', 'other': 'Autre' };
            
            container.innerHTML = documents.map(doc => `
                <div class="document-item ${window.selectedDocuments.includes(doc.id) ? 'selected' : ''}" onclick="toggleDocument('${doc.id}')">
                    <input type="checkbox" ${window.selectedDocuments.includes(doc.id) ? 'checked' : ''}>
                    <div class="info">
                        <div class="title">üìÑ ${doc.name}</div>
                        <div class="meta">${cats[doc.category] || 'Document'} ${doc.requiresAcceptance ? '‚Ä¢ ‚úÖ Acceptation requise' : ''}</div>
                    </div>
                </div>
            `).join('');
        }

        function toggleDocument(docId) {
            const index = window.selectedDocuments.indexOf(docId);
            if (index > -1) window.selectedDocuments.splice(index, 1);
            else window.selectedDocuments.push(docId);
            displayDocumentsList();
            updateSelectedDocuments();
        }

        function updateSelectedDocuments() {
            const container = document.getElementById('selected-documents-container');
            const list = document.getElementById('selected-docs-list');
            
            if (window.selectedDocuments.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            list.innerHTML = window.selectedDocuments.map((id, i) => {
                const doc = (window.allDocuments || []).find(d => d.id === id);
                return doc ? `<span class="selected-tag doc-selected">${i + 1}. ${doc.name} <button onclick="removeDocument('${id}')">&times;</button></span>` : '';
            }).join('');
        }

        function removeDocument(docId) {
            window.selectedDocuments = window.selectedDocuments.filter(id => id !== docId);
            displayDocumentsList();
            updateSelectedDocuments();
        }

        // ==================== PROGRAMMES ====================
        function displayPrograms() {
            const container = document.getElementById('programs-container');
            const programs = window.allPrograms || [];
            const courses = window.allCourses || [];
            const documents = window.allDocuments || [];
            
            if (programs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üéì</div>
                        <h3>Aucun programme</h3>
                        <p>Cr√©ez votre premier programme</p>
                        <button class="btn btn-primary" onclick="showTab('create')">‚ûï Cr√©er</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `<div class="programs-grid">${programs.map(program => {
                const deadlineStr = program.deadline ? new Date(program.deadline).toLocaleDateString('fr-FR') : null;
                const isPassed = program.deadline && new Date(program.deadline) < new Date();
                
                return `
                    <div class="program-card">
                        <div class="program-header">
                            <span class="program-status">${program.status === 'published' ? '‚úì Publi√©' : '‚è≥ Brouillon'}</span>
                            <h3>${program.title || 'Sans titre'}</h3>
                            <p>${program.description?.substring(0, 60) || ''}${program.description?.length > 60 ? '...' : ''}</p>
                        </div>
                        <div class="program-body">
                            <div class="program-courses">
                                <h4>üìö ${program.courses?.length || 0} cours</h4>
                                ${(program.courses || []).slice(0, 3).map(cId => {
                                    const c = courses.find(x => x.id === cId);
                                    return c ? `<span class="course-tag">${c.title}</span>` : '';
                                }).join('')}
                                ${(program.courses?.length || 0) > 3 ? `<span class="course-tag">+${program.courses.length - 3}</span>` : ''}
                            </div>
                            ${(program.documents?.length || 0) > 0 ? `
                            <div class="program-courses">
                                <h4>üìÑ ${program.documents.length} document(s)</h4>
                                ${(program.documents || []).slice(0, 2).map(dId => {
                                    const d = documents.find(x => x.id === dId);
                                    return d ? `<span class="doc-tag">${d.name}</span>` : '';
                                }).join('')}
                                ${(program.documents?.length || 0) > 2 ? `<span class="doc-tag">+${program.documents.length - 2}</span>` : ''}
                            </div>
                            ` : ''}
                            <div class="program-meta">
                                ${deadlineStr ? `<span class="deadline ${isPassed ? 'deadline-passed' : ''}">üìÖ ${deadlineStr}${isPassed ? ' (pass√©e)' : ''}</span>` : ''}
                            </div>
                            <div class="program-actions">
                                <button class="btn-edit" onclick="editProgram('${program.id}')">‚úèÔ∏è Modifier</button>
                                <button class="btn-delete" onclick="deleteProgram('${program.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('')}</div>`;
        }

        function editProgram(programId) {
            const program = window.allPrograms.find(p => p.id === programId);
            if (!program) return;
            
            window.editingProgramId = programId;
            document.getElementById('title').value = program.title || '';
            document.getElementById('description').value = program.description || '';
            
            if (program.deadline) {
                const d = new Date(program.deadline);
                document.getElementById('deadline').value = d.toISOString().split('T')[0];
                document.getElementById('deadline-time').value = d.toTimeString().slice(0, 5);
            } else {
                document.getElementById('deadline').value = '';
                document.getElementById('deadline-time').value = '23:59';
            }
            
            window.selectedCourses = program.courses || [];
            window.selectedDocuments = program.documents || [];
            displayCoursesList();
            updateSelectedCourses();
            displayDocumentsList();
            updateSelectedDocuments();
            document.querySelectorAll('.tab')[1].click();
        }

        async function deleteProgram(programId) {
            if (!confirm('Supprimer ce programme ?')) return;
            try {
                await window.deleteDoc(window.doc(window.firebaseDb, "programs", programId));
                showMessage('‚úÖ Programme supprim√©', 'success');
                await window.loadData();
            } catch (error) {
                showMessage('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        function getProgramData(status) {
            let deadline = null;
            const deadlineDate = document.getElementById('deadline').value;
            const deadlineTime = document.getElementById('deadline-time').value || '23:59';
            if (deadlineDate) deadline = new Date(`${deadlineDate}T${deadlineTime}`).toISOString();
            
            return {
                title: document.getElementById('title').value.trim(),
                description: document.getElementById('description').value.trim(),
                deadline: deadline,
                courses: window.selectedCourses,
                documents: window.selectedDocuments,
                status: status,
                updatedAt: new Date().toISOString()
            };
        }

        async function saveDraft() {
            const title = document.getElementById('title').value.trim();
            if (!title) { showMessage('‚ùå Titre requis', 'error'); return; }
            
            try {
                const data = getProgramData('draft');
                if (window.editingProgramId) {
                    await window.updateDoc(window.doc(window.firebaseDb, "programs", window.editingProgramId), data);
                } else {
                    data.createdAt = new Date().toISOString();
                    await window.addDoc(window.collection(window.firebaseDb, "programs"), data);
                }
                showMessage('‚úÖ Brouillon enregistr√© !', 'success');
                await window.loadData();
            } catch (error) {
                showMessage('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        async function publishProgram() {
            const title = document.getElementById('title').value.trim();
            if (!title) { showMessage('‚ùå Titre requis', 'error'); return; }
            if (window.selectedCourses.length === 0) { showMessage('‚ùå S√©lectionnez au moins un cours', 'error'); return; }
            
            try {
                const data = getProgramData('published');
                if (window.editingProgramId) {
                    await window.updateDoc(window.doc(window.firebaseDb, "programs", window.editingProgramId), data);
                } else {
                    data.createdAt = new Date().toISOString();
                    await window.addDoc(window.collection(window.firebaseDb, "programs"), data);
                }
                showMessage('‚úÖ Programme publi√© !', 'success');
                resetForm();
                await window.loadData();
                document.querySelectorAll('.tab')[0].click();
            } catch (error) {
                showMessage('‚ùå Erreur: ' + error.message, 'error');
            }
        }

        function resetForm() {
            window.editingProgramId = null;
            window.selectedCourses = [];
            window.selectedDocuments = [];
            document.getElementById('title').value = '';
            document.getElementById('description').value = '';
            document.getElementById('deadline').value = '';
            document.getElementById('deadline-time').value = '23:59';
            displayCoursesList();
            updateSelectedCourses();
            displayDocumentsList();
            updateSelectedDocuments();
        }
    </script>
</body>
</html>
