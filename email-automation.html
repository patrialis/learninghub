<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emails - LearningHub</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --brown: #8B6F47; --dark-brown: #6B5A3B; --beige: #E8DCC4; --light-gray: #F5F5F0; --green: #6B9F7F; --dark-green: #5A8A6E; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--light-gray); min-height: 100vh; padding: 20px; }
        
        .container { max-width: 900px; margin: 0 auto; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { color: var(--dark-brown); display: flex; align-items: center; gap: 10px; }
        .back-btn { background: var(--beige); border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; color: var(--dark-brown); font-weight: 500; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
        .back-btn:hover { background: #d9cab3; }
        
        .card { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .card h2 { color: var(--dark-brown); margin-bottom: 20px; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .card p.description { color: #888; margin-bottom: 20px; font-size: 0.95rem; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: var(--dark-brown); font-weight: 500; }
        .form-group select { width: 100%; padding: 12px 15px; border: 2px solid var(--beige); border-radius: 10px; font-size: 1rem; transition: all 0.3s; cursor: pointer; }
        .form-group select:focus { outline: none; border-color: var(--green); }
        
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        .btn { padding: 12px 25px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; font-size: 1rem; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--green); color: white; }
        .btn-primary:hover { background: var(--dark-green); }
        .btn-copy { background: #007bff; color: white; }
        .btn-copy:hover { background: #0056b3; }
        .btn-copy.copied { background: var(--green); }
        
        .info-box { background: #e7f3ff; border: 1px solid #b3d7ff; border-radius: 10px; padding: 15px; margin-bottom: 20px; }
        .info-box.warning { background: #fff3cd; border-color: #ffc107; }
        .info-box p { color: #004085; font-size: 0.9rem; }
        .info-box.warning p { color: #856404; }
        
        .result-section { display: none; }
        .result-section.active { display: block; }
        
        .copy-block { background: var(--light-gray); border-radius: 10px; padding: 20px; margin-bottom: 20px; position: relative; }
        .copy-block h3 { color: var(--dark-brown); font-size: 1rem; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .copy-block .content { background: white; border: 2px solid var(--beige); border-radius: 8px; padding: 15px; font-family: monospace; font-size: 0.9rem; max-height: 200px; overflow-y: auto; white-space: pre-wrap; word-break: break-all; }
        .copy-block .content.emails { color: #0066cc; }
        
        .stats-row { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-badge { background: var(--green); color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: 500; }
        .stat-badge.warning { background: #ffc107; color: #000; }
        .stat-badge.danger { background: #dc3545; }
        
        .deadline-info { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 0 10px 10px 0; margin-bottom: 20px; }
        .deadline-info strong { color: #856404; }
        
        .loading { text-align: center; padding: 40px; color: #888; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--beige); border-top: 4px solid var(--green); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìß Pr√©parer un Email</h1>
            <a href="instructor-dashboard.html" class="back-btn">‚Üê Retour</a>
        </div>

        <!-- Step 1: Configuration -->
        <div class="card">
            <h2>1Ô∏è‚É£ Configurer l'email</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Type d'email</label>
                    <select id="email-type" onchange="updateOptions()">
                        <option value="announcement">üì¢ Annonce g√©n√©rale</option>
                        <option value="reminder">‚è∞ Rappel de formation</option>
                        <option value="welcome">üëã Bienvenue</option>
                        <option value="new_course">üìö Nouveau cours disponible</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Destinataires</label>
                    <select id="recipients-type" onchange="updateCourseSelect()">
                        <option value="all">üì¢ Tous les √©tudiants</option>
                        <option value="course">üìö √âtudiants d'un cours</option>
                        <option value="program">üéì √âtudiants d'un programme</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group" id="course-select-group" style="display: none;">
                <label>S√©lectionner le cours</label>
                <select id="course-select" onchange="updateDeadlineInfo()">
                    <option value="">-- Choisir --</option>
                </select>
            </div>
            
            <div class="form-group" id="program-select-group" style="display: none;">
                <label>S√©lectionner le programme</label>
                <select id="program-select">
                    <option value="">-- Choisir --</option>
                </select>
            </div>
            
            <div id="deadline-info" class="deadline-info" style="display: none;">
                <strong>üìÖ Deadline du cours :</strong> <span id="deadline-date">-</span>
            </div>
            
            <div class="info-box warning" id="reminder-info" style="display: none;">
                <p>‚ö†Ô∏è <strong>Rappel :</strong> Seuls les √©tudiants qui n'ont <strong>PAS encore termin√©</strong> le cours recevront l'email.</p>
            </div>
            
            <button class="btn btn-primary" onclick="generateEmail()">‚ú® G√©n√©rer l'email</button>
        </div>

        <!-- Step 2: Results -->
        <div id="result-section" class="result-section">
            <div class="card">
                <h2>2Ô∏è‚É£ Copier-coller dans votre messagerie</h2>
                
                <div class="stats-row" id="stats-row"></div>
                
                <!-- Emails -->
                <div class="copy-block">
                    <h3>
                        üìß Adresses emails (√† mettre en BCC/CCI)
                        <button class="btn btn-copy" onclick="copyToClipboard('emails-content', this)">üìã Copier</button>
                    </h3>
                    <div class="content emails" id="emails-content">-</div>
                </div>
                
                <!-- Subject -->
                <div class="copy-block">
                    <h3>
                        üìù Objet de l'email
                        <button class="btn btn-copy" onclick="copyToClipboard('subject-content', this)">üìã Copier</button>
                    </h3>
                    <div class="content" id="subject-content" style="font-family: 'Aptos', Calibri, Arial, sans-serif;">-</div>
                </div>
                
                <!-- Body -->
                <div class="copy-block">
                    <h3>
                        üí¨ Corps du message
                        <button class="btn btn-copy" onclick="copyToClipboard('body-content', this)">üìã Copier</button>
                    </h3>
                    <div class="content" id="body-content" style="font-family: 'Aptos', Calibri, Arial, sans-serif;">-</div>
                </div>
            </div>
            
            <div class="info-box">
                <p>üí° <strong>Conseil :</strong> Utilisez le champ <strong>BCC (ou CCI)</strong> pour les destinataires afin de prot√©ger leur vie priv√©e. Chaque √©tudiant ne verra pas les autres adresses.</p>
            </div>
            
            <div class="info-box" style="margin-top: 15px;">
                <p>üî§ <strong>Police recommand√©e :</strong> Pour une meilleure pr√©sentation, s√©lectionnez la police <strong>Aptos</strong> (ou Calibri) dans votre client email apr√®s avoir coll√© le texte.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { getFirestore, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAVO1P9v-IBsyxF_80vQvZDlR5tIqh878U",
            authDomain: "learncentric.firebaseapp.com",
            projectId: "learncentric",
            storageBucket: "learncentric.firebasestorage.app",
            messagingSenderId: "1083770541694",
            appId: "1:1083770541694:web:b8dbcd7852ca7d9c8fea2f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                window.currentUser = user;
                await loadData();
            } else {
                window.location.href = 'index.html';
            }
        });

        async function loadData() {
            try {
                // Load students
                const usersSnapshot = await getDocs(collection(db, "users"));
                window.allStudents = [];
                usersSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.email && (data.role === 'student' || !data.role)) {
                        window.allStudents.push({ id: doc.id, ...data });
                    }
                });
                
                // Load courses
                const coursesSnapshot = await getDocs(collection(db, "courses"));
                window.allCourses = [];
                coursesSnapshot.forEach(doc => {
                    window.allCourses.push({ id: doc.id, ...doc.data() });
                });
                
                // Load programs
                const programsSnapshot = await getDocs(collection(db, "programs"));
                window.allPrograms = [];
                programsSnapshot.forEach(doc => {
                    window.allPrograms.push({ id: doc.id, ...doc.data() });
                });
                
                populateSelects();
                
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        function populateSelects() {
            const courseSelect = document.getElementById('course-select');
            courseSelect.innerHTML = '<option value="">-- Choisir --</option>';
            (window.allCourses || []).forEach(course => {
                const deadlineStr = course.deadline ? ` (üìÖ ${new Date(course.deadline).toLocaleDateString('fr-FR')})` : '';
                courseSelect.innerHTML += `<option value="${course.id}">${course.title}${deadlineStr}</option>`;
            });
            
            const programSelect = document.getElementById('program-select');
            programSelect.innerHTML = '<option value="">-- Choisir --</option>';
            (window.allPrograms || []).forEach(program => {
                const deadlineStr = program.deadline ? ` (üìÖ ${new Date(program.deadline).toLocaleDateString('fr-FR')})` : '';
                programSelect.innerHTML += `<option value="${program.id}">${program.title}${deadlineStr}</option>`;
            });
        }

        window.loadData = loadData;
    </script>

    <script>
        // Email templates
        const templates = {
            announcement: {
                subject: "Information importante - LearningHub",
                body: `Bonjour,

Nous souhaitons vous informer d'une actualit√© importante concernant votre espace de formation.

[Votre message personnalis√© ici]

Acc√©dez √† la plateforme : https://patrialis.github.io/learninghub/

Cordialement,
L'√©quipe LearningHub`
            },
            reminder: {
                subject: "Rappel : Terminez votre formation avant le {{deadline}}",
                body: `Bonjour,

Ce message est un rappel concernant votre formation : {{cours}}

Date limite : {{deadline}}

Nous vous invitons √† terminer cette formation avant la date indiqu√©e.

Acc√©dez √† votre formation : https://patrialis.github.io/learninghub/

Cordialement,
L'√©quipe LearningHub`
            },
            welcome: {
                subject: "Bienvenue sur LearningHub - Cr√©ez votre compte",
                body: `Bonjour,

Bienvenue sur LearningHub !

Vous avez √©t√© inscrit(e) sur notre plateforme de formation en ligne.

Pour acc√©der √† vos formations, veuillez cr√©er votre compte en suivant ces √©tapes :

1. Rendez-vous sur : https://patrialis.github.io/learninghub/
2. Cliquez sur "Inscription"
3. Utilisez cette adresse email pour cr√©er votre compte
4. Choisissez un mot de passe

Une fois votre compte cr√©√©, vous pourrez acc√©der √† toutes vos formations assign√©es.

√Ä bient√¥t !
L'√©quipe LearningHub`
            },
            new_course: {
                subject: "Nouveau cours disponible : {{cours}}",
                body: `Bonjour,

Un nouveau cours est maintenant disponible : {{cours}}

{{deadline_info}}

D√©couvrez-le ici : https://patrialis.github.io/learninghub/

Bon apprentissage !
L'√©quipe LearningHub`
            }
        };

        // Font style note
        const fontStyle = "font-family: 'Aptos', Calibri, Arial, sans-serif;";

        function updateOptions() {
            const type = document.getElementById('email-type').value;
            document.getElementById('reminder-info').style.display = type === 'reminder' ? 'block' : 'none';
            
            // For reminder, force course selection
            if (type === 'reminder') {
                document.getElementById('recipients-type').value = 'course';
                updateCourseSelect();
            }
        }

        function updateCourseSelect() {
            const type = document.getElementById('recipients-type').value;
            document.getElementById('course-select-group').style.display = type === 'course' ? 'block' : 'none';
            document.getElementById('program-select-group').style.display = type === 'program' ? 'block' : 'none';
            updateDeadlineInfo();
        }

        function updateDeadlineInfo() {
            const courseId = document.getElementById('course-select').value;
            const course = (window.allCourses || []).find(c => c.id === courseId);
            
            if (course && course.deadline) {
                const date = new Date(course.deadline);
                document.getElementById('deadline-date').textContent = date.toLocaleDateString('fr-FR', { 
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                });
                document.getElementById('deadline-info').style.display = 'block';
            } else {
                document.getElementById('deadline-info').style.display = 'none';
            }
        }

        function generateEmail() {
            const emailType = document.getElementById('email-type').value;
            const recipientsType = document.getElementById('recipients-type').value;
            const courseId = document.getElementById('course-select').value;
            const programId = document.getElementById('program-select').value;
            
            // Get course/program info
            let selectedCourse = null;
            let selectedProgram = null;
            let courseName = '';
            let deadlineStr = '';
            let deadlineInfo = '';
            
            if (recipientsType === 'course' && courseId) {
                selectedCourse = (window.allCourses || []).find(c => c.id === courseId);
                if (selectedCourse) {
                    courseName = selectedCourse.title;
                    if (selectedCourse.deadline) {
                        const d = new Date(selectedCourse.deadline);
                        deadlineStr = d.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                        deadlineInfo = `üìÖ Date limite pour compl√©ter ce cours : ${deadlineStr}`;
                    }
                }
            } else if (recipientsType === 'program' && programId) {
                selectedProgram = (window.allPrograms || []).find(p => p.id === programId);
                if (selectedProgram) {
                    courseName = selectedProgram.title;
                    if (selectedProgram.deadline) {
                        const d = new Date(selectedProgram.deadline);
                        deadlineStr = d.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                        deadlineInfo = `üìÖ Date limite pour compl√©ter ce programme : ${deadlineStr}`;
                    }
                }
            }
            
            // Get recipients
            let recipients = [];
            const allStudents = window.allStudents || [];
            
            if (recipientsType === 'all') {
                recipients = allStudents.filter(s => s.email);
            } else if (recipientsType === 'course' && courseId) {
                // Get students assigned to this course
                let assignedStudents = allStudents.filter(s => 
                    s.email && s.assignedCourses && s.assignedCourses.includes(courseId)
                );
                
                // For reminders: only those who haven't completed
                if (emailType === 'reminder') {
                    recipients = assignedStudents.filter(s => {
                        const progress = s.progress && s.progress[courseId];
                        return !progress || progress.percent < 100;
                    });
                } else {
                    recipients = assignedStudents;
                }
            } else if (recipientsType === 'program' && programId) {
                let assignedStudents = allStudents.filter(s => 
                    s.email && s.assignedPrograms && s.assignedPrograms.includes(programId)
                );
                
                if (emailType === 'reminder') {
                    // For programs, check if all courses are completed
                    recipients = assignedStudents.filter(s => {
                        if (!selectedProgram || !selectedProgram.courses) return true;
                        const allCompleted = selectedProgram.courses.every(cId => {
                            const progress = s.progress && s.progress[cId];
                            return progress && progress.percent >= 100;
                        });
                        return !allCompleted;
                    });
                } else {
                    recipients = assignedStudents;
                }
            }
            
            // Generate email content
            const template = templates[emailType];
            let subject = template.subject
                .replace('{{cours}}', courseName)
                .replace('{{deadline}}', deadlineStr || '√† d√©finir');
            
            let body = template.body
                .replace('{{cours}}', courseName)
                .replace('{{deadline}}', deadlineStr || '√† d√©finir')
                .replace('{{deadline_info}}', deadlineInfo);
            
            // Display results
            const emails = recipients.map(r => r.email).join('; ');
            
            document.getElementById('emails-content').textContent = emails || 'Aucun destinataire trouv√©';
            document.getElementById('subject-content').textContent = subject;
            document.getElementById('body-content').textContent = body;
            
            // Stats
            const completedCount = recipientsType === 'course' && courseId ? 
                allStudents.filter(s => s.assignedCourses?.includes(courseId) && s.progress?.[courseId]?.percent >= 100).length : 0;
            const totalAssigned = recipientsType === 'course' && courseId ?
                allStudents.filter(s => s.assignedCourses?.includes(courseId)).length : 0;
            
            let statsHtml = `<span class="stat-badge">üìß ${recipients.length} destinataire(s)</span>`;
            
            if (emailType === 'reminder' && recipientsType === 'course') {
                statsHtml += `<span class="stat-badge warning">‚è≥ ${recipients.length} n'ont pas termin√©</span>`;
                statsHtml += `<span class="stat-badge" style="background:#28a745;">‚úÖ ${completedCount} ont termin√©</span>`;
            }
            
            document.getElementById('stats-row').innerHTML = statsHtml;
            
            // Show results
            document.getElementById('result-section').classList.add('active');
            document.getElementById('result-section').scrollIntoView({ behavior: 'smooth' });
        }

        function copyToClipboard(elementId, button) {
            const content = document.getElementById(elementId).textContent;
            navigator.clipboard.writeText(content).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = '‚úÖ Copi√© !';
                button.classList.add('copied');
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Erreur copie:', err);
                alert('Erreur lors de la copie. S√©lectionnez le texte manuellement.');
            });
        }
    </script>
</body>
</html>
