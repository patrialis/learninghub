<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document - LearningHub</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --brown: #8B6F47; --dark-brown: #6B5A3B; --beige: #E8DCC4; --light-gray: #F5F5F0; --green: #6B9F7F; --dark-green: #5A8A6E; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--light-gray); min-height: 100vh; }
        
        .header { background: linear-gradient(135deg, var(--brown), var(--dark-brown)); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .header h1 { font-size: 1.3rem; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; font-size: 0.95rem; }
        .btn-secondary { background: rgba(255,255,255,0.2); color: white; }
        .btn-secondary:hover { background: rgba(255,255,255,0.3); }
        .btn-primary { background: var(--green); color: white; }
        .btn-primary:hover { background: var(--dark-green); }
        .btn-download { background: var(--brown); color: white; }
        .btn-download:hover { background: var(--dark-brown); }
        
        .container { max-width: 1000px; margin: 0 auto; padding: 30px 20px; }
        .card { background: white; border-radius: 15px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        .document-info h2 { color: var(--dark-brown); margin-bottom: 10px; font-size: 1.4rem; }
        .document-info .summary { color: #666; line-height: 1.6; padding: 15px; background: var(--light-gray); border-radius: 10px; margin-bottom: 15px; }
        .document-info .meta { display: flex; gap: 20px; flex-wrap: wrap; color: #888; font-size: 0.9rem; }
        
        .pdf-viewer { border: 2px solid var(--beige); border-radius: 10px; overflow: hidden; }
        .pdf-viewer iframe { width: 100%; height: 70vh; border: none; }
        
        .actions-bar { display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 20px; }
        .actions-bar .btn { flex: 1; min-width: 200px; justify-content: center; padding: 15px; font-size: 1rem; }
        
        .acceptance-section { background: var(--beige); border-radius: 15px; padding: 25px; text-align: center; }
        .acceptance-section h3 { color: var(--dark-brown); margin-bottom: 15px; }
        .acceptance-section p { color: #666; margin-bottom: 20px; }
        .checkbox-container { display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .checkbox-container input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .checkbox-container label { color: var(--dark-brown); font-weight: 500; cursor: pointer; }
        .btn-accept { background: var(--green); color: white; padding: 15px 40px; font-size: 1.1rem; }
        .btn-accept:disabled { background: #ccc; cursor: not-allowed; }
        
        .already-accepted { background: #d4edda; border: 2px solid #28a745; border-radius: 15px; padding: 25px; text-align: center; }
        .already-accepted h3 { color: #155724; margin-bottom: 10px; }
        .already-accepted p { color: #155724; }
        
        .loading { text-align: center; padding: 60px; }
        .spinner { width: 50px; height: 50px; border: 4px solid var(--beige); border-top-color: var(--brown); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @media (max-width: 768px) {
            .header { padding: 15px; }
            .header h1 { font-size: 1.1rem; }
            .container { padding: 15px; }
            .pdf-viewer iframe { height: 50vh; }
            .actions-bar .btn { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìÑ <span id="header-title">Document</span></h1>
        <a href="student-dashboard.html" class="btn btn-secondary">‚Üê Retour</a>
    </div>

    <div class="container">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Chargement du document...</p>
        </div>
        
        <div id="main-content" style="display: none;">
            <div class="card document-info">
                <h2 id="doc-title">Titre du document</h2>
                <div class="summary" id="doc-summary">R√©sum√© du document</div>
                <div class="meta">
                    <span id="doc-category">üìÅ Cat√©gorie</span>
                    <span id="doc-date">üìÖ Date</span>
                </div>
            </div>
            
            <div class="actions-bar">
                <a href="#" id="btn-view-external" target="_blank" class="btn btn-primary">üëÅÔ∏è Ouvrir dans un nouvel onglet</a>
                <a href="#" id="btn-download" target="_blank" class="btn btn-download">üì• T√©l√©charger le PDF</a>
            </div>
            
            <div class="card">
                <div class="pdf-viewer">
                    <iframe id="pdf-frame" src=""></iframe>
                </div>
            </div>
            
            <div id="acceptance-section" class="acceptance-section" style="display: none;">
                <h3>Validation du document</h3>
                <p>Veuillez confirmer que vous avez lu et compris ce document avant de continuer.</p>
                <div class="checkbox-container">
                    <input type="checkbox" id="accept-checkbox" onchange="toggleAcceptButton()">
                    <label for="accept-checkbox">J'ai lu, compris et j'accepte ce document</label>
                </div>
                <button class="btn btn-accept" id="btn-accept" onclick="acceptDocument()" disabled>‚úÖ Valider ma lecture</button>
            </div>
            
            <div id="already-accepted" class="already-accepted" style="display: none;">
                <h3>‚úÖ Document valid√©</h3>
                <p>Vous avez accept√© ce document le <span id="accepted-date"></span>.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCHPpxXMALQOqS7VBGJ3FmFQ1rfm3D_CN4",
            authDomain: "learninghub-1b012.firebaseapp.com",
            projectId: "learninghub-1b012",
            storageBucket: "learninghub-1b012.appspot.com",
            messagingSenderId: "365508620037",
            appId: "1:365508620037:web:9e32e20571d62135d84588"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        window.db = db;
        window.doc = doc;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc;
        window.setDoc = setDoc;
        window.currentUser = null;
        window.currentDocument = null;

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }
            window.currentUser = user;
            
            const urlParams = new URLSearchParams(window.location.search);
            const docId = urlParams.get('id');
            
            if (docId) {
                await loadDocument(docId);
            } else {
                document.getElementById('loading').innerHTML = '<p style="color: #dc3545;">Document non trouv√©</p>';
            }
        });

        async function loadDocument(docId) {
            try {
                const docRef = doc(db, "documents", docId);
                const docSnap = await getDoc(docRef);
                
                if (!docSnap.exists()) {
                    document.getElementById('loading').innerHTML = '<p style="color: #dc3545;">Document non trouv√©</p>';
                    return;
                }
                
                const docData = { id: docSnap.id, ...docSnap.data() };
                window.currentDocument = docData;
                
                displayDocument(docData);
                await checkAcceptanceStatus(docId);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('loading').innerHTML = '<p style="color: #dc3545;">Erreur lors du chargement</p>';
            }
        }

        function displayDocument(docData) {
            const cats = {
                'policy': 'üìã Politique / R√®glement',
                'guide': 'üìñ Guide / Manuel',
                'form': 'üìù Formulaire',
                'certificate': 'üéì Attestation',
                'other': 'üìÅ Document'
            };
            
            document.getElementById('header-title').textContent = docData.name || 'Document';
            document.getElementById('doc-title').textContent = docData.name || 'Document';
            document.getElementById('doc-summary').textContent = docData.summary || 'Aucun r√©sum√© disponible.';
            document.getElementById('doc-category').textContent = cats[docData.category] || 'üìÅ Document';
            
            const date = docData.createdAt ? new Date(docData.createdAt).toLocaleDateString('fr-FR') : '';
            document.getElementById('doc-date').textContent = date ? 'üìÖ ' + date : '';
            
            // Set PDF URL
            document.getElementById('pdf-frame').src = docData.url;
            document.getElementById('btn-view-external').href = docData.url;
            document.getElementById('btn-download').href = docData.url;
            
            if (docData.requiresAcceptance) {
                document.getElementById('acceptance-section').style.display = 'block';
            }
        }

        async function checkAcceptanceStatus(docId) {
            try {
                const userRef = doc(db, "users", window.currentUser.uid);
                const userSnap = await getDoc(userRef);
                
                if (userSnap.exists()) {
                    const acceptedDocs = userSnap.data().acceptedDocuments || {};
                    
                    if (acceptedDocs[docId]) {
                        document.getElementById('acceptance-section').style.display = 'none';
                        document.getElementById('already-accepted').style.display = 'block';
                        
                        const acceptedDate = new Date(acceptedDocs[docId]).toLocaleDateString('fr-FR', {
                            day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
                        });
                        document.getElementById('accepted-date').textContent = acceptedDate;
                    }
                }
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        window.loadDocument = loadDocument;
    </script>

    <script>
        function toggleAcceptButton() {
            document.getElementById('btn-accept').disabled = !document.getElementById('accept-checkbox').checked;
        }
        
        async function acceptDocument() {
            const docId = window.currentDocument?.id;
            if (!docId) return;
            
            try {
                const userRef = window.doc(window.db, "users", window.currentUser.uid);
                const userSnap = await window.getDoc(userRef);
                
                let acceptedDocs = {};
                if (userSnap.exists()) {
                    acceptedDocs = userSnap.data().acceptedDocuments || {};
                }
                
                acceptedDocs[docId] = new Date().toISOString();
                
                if (userSnap.exists()) {
                    await window.updateDoc(userRef, { acceptedDocuments: acceptedDocs });
                } else {
                    await window.setDoc(userRef, { acceptedDocuments: acceptedDocs }, { merge: true });
                }
                
                document.getElementById('acceptance-section').style.display = 'none';
                document.getElementById('already-accepted').style.display = 'block';
                
                const now = new Date().toLocaleDateString('fr-FR', {
                    day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                document.getElementById('accepted-date').textContent = now;
                
                alert('‚úÖ Document valid√© avec succ√®s !');
                
            } catch (error) {
                console.error('Erreur:', error);
                alert('Erreur lors de la validation');
            }
        }
    </script>
</body>
</html>
